#cloud-config
# Update apt database on first boot
# (ie run apt-get update)
#
# Default: true
# Aliases: apt_update
package_update: true

# Upgrade the instance on first boot
# (ie run apt-get upgrade)
#
# Default: false
# Aliases: apt_upgrade
#package_upgrade: true
hostname: crashdumps
manage_etc_hosts: true
ssh_import_id: [louis-bouchard]


packages:
 - nfs-kernel-server
 - crash
 - squid-deb-proxy

fs_setup:
   - label: crashfiles
     filesystem: ext4
     device: /dev/vdc
     partition: auto
   - label: longterm
     filesystem: ext4
     device: /dev/vdd
     partition: auto

mounts:
 - [ vdb, /squidproxy, auto, "defaults,noexec" ]
 - [ vdc, /crashfiles, auto, "defaults,noexec" ]
 - [ vdd, /longterm, auto, "defaults,noexec" ]

runcmd:
 - echo 'Acquire::http { Proxy "http://crashdumps:8000"; };' > /etc/apt/apt.conf
 - echo "/crashfiles *(rw,sync,no_root_squash)" >> /etc/exports
 - chmod 777 /squidproxy
 - chmod 777 /crashfiles
 - chmod 777 /longterm
 - mkdir /squidproxy/cache
 - mkdir -p /squidproxy/log/squid-deb-proxy
 - chown proxy:proxy /squidproxy/cache
 - chown -R proxy:proxy /squidproxy/log
 
write_files:
-   encoding: b64
    content: CiMgICAgICAgV0VMQ09NRSBUTyBTUVVJRCBERUIgUFJPWFkKIyAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0KIwojICAgICAgIFRoaXMgY29uZmlnIGZpbGUgaXMgYSB2ZXJzaW9uIG9mIGEgc3F1aWQgcHJveHkgZmlsZSBvcHRpbWl6ZWQKIwlhcyBhIGNvbmZpZ3VyYXRpb24gZm9yIGEgY2FjaGluZyBwcm94eSBmb3IgRGViaWFuL1VidW50dSBzeXN0ZW1zLgojCiMgICAgICAgTW9yZSBpbmZvcm1hdGlvbiBhYm91dCBzcXVpZCBhbmQgaXRzIGNvbmZpZ3VyYXRpb24gY2FuIGJlIGZvdW5kIGhlcmUKIyAgICAgICBodHRwOi8vd3d3LnNxdWlkLWNhY2hlLm9yZy8gYW5kIGluIHRoZSBGQVEKCiMgc2V0dGluZ3MgdGhhdCB5b3UgbWF5IHdhbnQgdG8gY3VzdG9taXplCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgojIHRoaXMgZmlsZSBjb250YWlucyBwcml2YXRlIG5ldHdvcmtzICgxMC4wLjAuMC84LCAxNzIuMTYuMC4wLzEyLAojIDE5Mi4xNjguMC4wLzE2KSBieSBkZWZhdWx0LCB5b3UgY2FuIGFkZC9yZW1vdmUgYWRkaXRpb25hbCBhbGxvd2VkCiMgc291cmNlIG5ldHdvcmtzIGluIGl0IHRvIGN1c3RvbWl6ZSBpdCBmb3IgeW91ciBzZXR1cAphY2wgYWxsb3dlZF9uZXR3b3JrcyBzcmMgIi9ldGMvc3F1aWQtZGViLXByb3h5L2F1dG9nZW5lcmF0ZWQvYWxsb3dlZC1uZXR3b3Jrcy1zcmMuYWNsIgoKIyB0aGlzIGZpbGUgY29udGFpbnMgdGhlIGFyY2hpdmUgbWlycm9ycyBieSBkZWZhdWx0LAojIGlmIHlvdSB1c2UgYSBkaWZmZXJlbnQgbWlycm9yLCBhZGQgaXQgdGhlcmUKYWNsIHRvX2FyY2hpdmVfbWlycm9ycyBkc3Rkb21haW4gIi9ldGMvc3F1aWQtZGViLXByb3h5L2F1dG9nZW5lcmF0ZWQvbWlycm9yLWRzdGRvbWFpbi5hY2wiCgojIHRoaXMgY29udGFpbnMgdGhlIHBhY2thZ2UgYmxhY2tsaXN0CmFjbCBibG9ja2VkcGtncyB1cmxwYXRoX3JlZ2V4ICIvZXRjL3NxdWlkLWRlYi1wcm94eS9hdXRvZ2VuZXJhdGVkL3BrZy1ibGFja2xpc3QtcmVnZXhwLmFjbCIKCiMgZGVmYXVsdCB0byBhIGRpZmZlcmVudCBwb3J0IHRoYW4gc3RvY2sgc3F1aWQKaHR0cF9wb3J0IDgwMDAKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIHNldHRpbmdzIGJlbG93IHByb2JhYmx5IGRvIG5vdCBuZWVkIGN1c3RvbWl6YXRpb24KCiMgdXNlciB2aXNpYmxlIG5hbWUKdmlzaWJsZV9ob3N0bmFtZSBzcXVpZC1kZWItcHJveHkKCiMgd2UgbmVlZCBhIGJpZyBjYWNoZSwgc29tZSBkZWJzIGFyZSBodWdlCm1heGltdW1fb2JqZWN0X3NpemUgNTEyIE1CCgojIHVzZSBhIGRpZmZlcmVudCBkaXIgdGhhbiBzdG9jayBzcXVpZCBhbmQgZGVmYXVsdCB0byA0MEcKY2FjaGVfZGlyIGF1ZnMgL3NxdWlkcHJveHkvY2FjaGUvc3F1aWQtZGViLXByb3h5IDQwMDAwIDE2IDI1NgoKIyB1c2UgZGlmZmVyZW50IGxvZ3MKY2FjaGVfYWNjZXNzX2xvZyAvc3F1aWRwcm94eS9sb2cvc3F1aWQtZGViLXByb3h5L2FjY2Vzcy5sb2cKY2FjaGVfbG9nIC9zcXVpZHByb3h5L2xvZy9zcXVpZC1kZWItcHJveHkvY2FjaGUubG9nCmNhY2hlX3N0b3JlX2xvZyAvc3F1aWRwcm94eS9sb2cvc3F1aWQtZGViLXByb3h5L3N0b3JlLmxvZwoKIyB0d2Vha3MgdG8gc3BlZWQgdGhpbmdzIHVwCmNhY2hlX21lbSAyMDAgTUIKbWF4aW11bV9vYmplY3Rfc2l6ZV9pbl9tZW1vcnkgMTAyNDAgS0IKCiMgcGlkCnBpZF9maWxlbmFtZSAvdmFyL3J1bi9zcXVpZC1kZWItcHJveHkucGlkCgojIHJlZnJlc2ggcGF0dGVybiBmb3IgZGVicyBhbmQgdWRlYnMKcmVmcmVzaF9wYXR0ZXJuIGRlYiQgICAxMjk2MDAgMTAwJSAxMjk2MDAKcmVmcmVzaF9wYXR0ZXJuIHVkZWIkICAgMTI5NjAwIDEwMCUgMTI5NjAwCnJlZnJlc2hfcGF0dGVybiB0YXIuZ3okICAxMjk2MDAgMTAwJSAxMjk2MDAKCiMgYWx3YXlzIHJlZnJlc2ggUGFja2FnZXMgYW5kIFJlbGVhc2UgZmlsZXMKcmVmcmVzaF9wYXR0ZXJuIFwvKFBhY2thZ2VzfFNvdXJjZXMpKHxcLmJ6MnxcLmd6fFwueHopJCAwIDAlIDAKcmVmcmVzaF9wYXR0ZXJuIFwvUmVsZWFzZSh8XC5ncGcpJCAwIDAlIDAKcmVmcmVzaF9wYXR0ZXJuIFwvSW5SZWxlYXNlJCAwIDAlIDAKCiMgaGFuZGxlIG1ldGEtcmVsZWFzZSBhbmQgY2hhbmdlbG9ncy51YnVudHUuY29tIHNwZWNpYWwKIyAoZmluZSB0byBoYXZlIHRoaXMgb24gZGViaWFuIHRvbykKcmVmcmVzaF9wYXR0ZXJuIGNoYW5nZWxvZ3MudWJ1bnR1LmNvbS8qICAwICAxJSAxCgojIG9ubHkgYWxsb3cgY29ubmVjdHMgdG8gcG9ydHMgZm9yIGh0dHAsIGh0dHBzCmFjbCBTYWZlX3BvcnRzIHBvcnQgODAKYWNsIFNhZmVfcG9ydHMgcG9ydCA0NDMgNTYzICAgCgojIG9ubHkgYWxsb3cgcG9ydHMgd2UgdHJ1c3QKaHR0cF9hY2Nlc3MgZGVueSAhU2FmZV9wb3J0cwoKIyBkbyBub3QgYWxsb3cgdG8gZG93bmxvYWQgZnJvbSB0aGUgcGtnIGJsYWNrbGlzdApodHRwX2FjY2VzcyBkZW55IGJsb2NrZWRwa2dzCgojIGFsbG93IGFjY2VzcyBvbmx5IHRvIG9mZmljaWFsIGFyY2hpdmUgbWlycm9ycwojIHVuY29tbWVudCB0aGUgdGhpcmQgYW5kIGZvdXRoIGxpbmUgdG8gcGVybWl0IGFueSB1bmxpc3RlZCBkb21haW4KaHR0cF9hY2Nlc3MgZGVueSAhdG9fYXJjaGl2ZV9taXJyb3JzCiNodHRwX2FjY2VzcyBhbGxvdyAhdG9fYXJjaGl2ZV9taXJyb3JzCgojIGRvbid0IGNhY2hlIGRvbWFpbnMgbm90IGxpc3RlZCBpbiB0aGUgbWlycm9ycyBmaWxlCiMgdW5jb21tZW50IHRoZSB0aGlyZCBhbmQgZm91cnRoIGxpbmUgdG8gY2FjaGUgYW55IHVubGlzdGVkIGRvbWFpbnMKY2FjaGUgZGVueSAhdG9fYXJjaGl2ZV9taXJyb3JzCiNjYWNoZSBhbGxvdyAhdG9fYXJjaGl2ZV9taXJyb3JzCgojIGFsbG93IGFjY2VzcyBmcm9tIG91ciBuZXR3b3JrIGFuZCBsb2NhbGhvc3QKaHR0cF9hY2Nlc3MgYWxsb3cgYWxsb3dlZF9uZXR3b3JrcwoKIyBBbmQgZmluYWxseSBkZW55IGFsbCBvdGhlciBhY2Nlc3MgdG8gdGhpcyBwcm94eQpodHRwX2FjY2VzcyBkZW55IGFsbAo=
    owner: root:root
    path: /etc/squid-deb-proxy/squid-deb-proxy.conf
    permissions: '0600'

power_state:
 delay: now
 mode: reboot
 message: Rebooting after crashdump setup
